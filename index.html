<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë©”ê°€ìŠ¤í„°ë”” ëŸ¬ì…€ ì±—ë´‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    .app {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      height: 700px;
    }
    header {
      background: #0072ff;
      color: #ffffff;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    header h1 {
      font-size: 16px;
      font-weight: 700;
    }
    header span {
      font-size: 12px;
      opacity: 0.9;
    }
    .chat-area {
      flex: 1;
      padding: 12px 14px;
      overflow-y: auto;
      background: #f9fafb;
    }
    .msg {
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }
    .msg-bot .bubble {
      background: #e5e7eb;
      color: #111827;
      border-radius: 14px;
      border-bottom-left-radius: 4px;
    }
    .bubble {
      font-size: 13px;
      padding: 9px 11px;
      line-height: 1.4;
      max-width: 85%;
      white-space: pre-line;
    }
    .link-list {
      margin-top: 6px;
      font-size: 12px;
    }
    .link-list a {
      color: #2563eb;
      text-decoration: none;
    }
    .link-list a:hover {
      text-decoration: underline;
    }
    .btn-area {
      border-top: 1px solid #e5e7eb;
      padding: 10px 10px 14px;
      background: #ffffff;
    }
    .btn-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .btn-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 12px;
      background: #ffffff;
      cursor: pointer;
    }
    .chip-btn.main {
      font-weight: 600;
    }
    .chip-btn:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>ë©”ê°€ìŠ¤í„°ë”” ëŸ¬ì…€ ì±—ë´‡</h1>
    <span>ëŒ€ì¹˜í•™ì› ì•ˆë‚´</span>
  </header>

  <div class="chat-area" id="chat"></div>

  <div class="btn-area">
    <div class="btn-title" id="btn-title">ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
    <div class="btn-list" id="btn-list"></div>
  </div>
</div>

<script>
  /* ===============================
     ë©”ë‰´ & URL ì„¤ì •: russel.jsonì—ì„œ ë¡œë“œ
     =============================== */

  // russel.json ë‚´ìš©ì„ ë‹´ì„ ê°ì²´
  let MENU_DATA = {};
  let MAIN_MENUS = [];

  // DOM ìš”ì†Œ
  const chat = document.getElementById("chat");
  const btnList = document.getElementById("btn-list");
  const btnTitle = document.getElementById("btn-title");

  // [ìš°ì„ ì¶”ê°€] Google Apps Script ì›¹í›… URL (êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ìš©)
  const SHEET_WEBHOOK_URL =
    "https://script.google.com/macros/s/AKfycbyyz-H4DhCk3fRDOJIo55ReRVabSCccHLAmfNbsgBvu8z3IiyUJH10mWDR9Ca371tMM/exec";

  // [ìš°ì„ ì¶”ê°€] í˜„ì¬ ìˆ˜ê°•ì¤‘ ê°•ì¢Œ ëª©ë¡ (ë‹¨ê³¼ í™˜ë¶ˆ ì‹œ ì„ íƒìš© ë”ë¯¸ ë°ì´í„°)
  // ì‹¤ì œ ìš´ì˜ ì‹œ ì—¬ê¸°ì— ê°•ì¢Œëª…ì„ ì§ì ‘ ì¶”ê°€í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ.
  const currentCoursesData = [
    // ì˜ˆì‹œ:
    // "ê³ 3 êµ­ì–´ ì‹¬í™”ë°˜",
    // "ê³ 3 ìˆ˜í•™ ë‹¨ê³¼(ê¸°í•˜)",
    // "Nìˆ˜ ì˜ì–´ ì‹¤ì „ë°˜"
  ];

  /* ===============================
     ê³µí†µ JS ë¡œì§
     =============================== */

  function addBotMessage(text, linksHtml = "") {
    const wrap = document.createElement("div");
    wrap.className = "msg msg-bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    // âœ… ì˜¤íƒ€ ìˆ˜ì •: í’ì„ ê»Œ â†’ bubble
    wrap.appendChild(bubble);

    if (linksHtml) {
      const box = document.createElement("div");
      box.className = "link-list";
      box.innerHTML = linksHtml;
      bubble.appendChild(document.createElement("br"));
      bubble.appendChild(box);
    }

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  function renderMainButtons() {
    btnTitle.textContent = "ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    btnList.innerHTML = "";

    MAIN_MENUS.forEach(menu => {
      const btn = document.createElement("button");
      btn.className = "chip-btn main";
      btn.textContent = menu;
      btn.onclick = () => openMenu(menu);
      btnList.appendChild(btn);
    });
  }

  function openMenu(menuName) {
    const items = MENU_DATA[menuName];
    if (!items) return;

    addBotMessage(`ã€${menuName}ã€ ê´€ë ¨ ì£¼ìš” ë©”ë‰´ì…ë‹ˆë‹¤.\nì›í•˜ì‹œëŠ” í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.`);

    btnTitle.textContent = `${menuName} ì„¸ë¶€ ë©”ë‰´`;
    btnList.innerHTML = "";

    items.forEach(item => {
      const btn = document.createElement("button");
      btn.className = "chip-btn";
      btn.textContent = item.label;
      btn.title = item.desc || "";

      // [ìš°ì„ ì¶”ê°€] ë‚˜ì˜ ìˆ˜ê°•ì •ë³´ ë©”ë‰´ ë‚´ íŠ¹ìˆ˜ ë™ì‘ ë¶„ê¸°
      if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "ìˆ˜ê°•ì •ë³´") {
        btn.onclick = () => handleCourseInfo();
      } else if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "ëŒ€ê¸°ì •ë³´") {
        btn.onclick = () => handleWaitingInfo();
      } else if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "ê²°ì œë‚´ì—­") {
        btn.onclick = () => handlePaymentInfo();
      } else if (menuName === "ë‚˜ì˜ ìˆ˜ê°•ì •ë³´" && item.label === "í™˜ë¶ˆì‹ ì²­") {
        btn.onclick = () => renderRefundSubMenu();
      } else {
        // ê¸°ë³¸ ë™ì‘: í˜ì´ì§€ ì´ë™ + ë§í¬ ì•ˆë‚´
        btn.onclick = () => {
          if (!item.url) {
            addBotMessage(`${item.label} í˜ì´ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
          }
          const html = `<a href="${item.url}" target="_blank">${item.label} ë°”ë¡œê°€ê¸°</a>`;
          addBotMessage(`${item.label} í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.\n(${item.desc || ""})`, html);
          window.open(item.url, "_blank");
        };
      }

      btnList.appendChild(btn);
    });

    const homeBtn = document.createElement("button");
    homeBtn.className = "chip-btn";
    homeBtn.textContent = "â—€ ì²˜ìŒìœ¼ë¡œ";
    homeBtn.onclick = () => {
      addBotMessage("ì²˜ìŒ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
      renderMainButtons();
    };
    btnList.appendChild(homeBtn);
  }

  /* ===============================
     [ìš°ì„ ì¶”ê°€] ìˆ˜ê°•ì •ë³´ / ëŒ€ê¸°ì •ë³´ / ê²°ì œë‚´ì—­ ì²˜ë¦¬
     =============================== */

  // ìˆ˜ê°•ì •ë³´: í˜„ì¬ ìˆ˜ê°•ì¤‘ / ì§€ë‚œ ìˆ˜ê°•ë‚´ì—­ ì•ˆë‚´
  function handleCourseInfo() {
    const currentCourses = []; // ì‹¤ì œ ì—°ë™ ì‹œ ì—¬ê¸°ì— ë°ì´í„° ì£¼ì…
    const pastCourses = [];

    if (currentCourses.length === 0) {
      addBotMessage("ğŸ“Œ í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    } else {
      let msg = "ğŸ“Œ í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ê°•ì¢Œ ëª©ë¡:\n\n";
      currentCourses.forEach((c, i) => {
        msg += `${i + 1}. ${c}\n`;
      });
      addBotMessage(msg);
    }

    if (pastCourses.length === 0) {
      addBotMessage("ğŸ“š ì§€ë‚œ ìˆ˜ê°•ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    } else {
      let msg = "ğŸ“š ì§€ë‚œ ìˆ˜ê°•ë‚´ì—­:\n\n";
      pastCourses.forEach((c, i) => {
        msg += `${i + 1}. ${c}\n`;
      });
      addBotMessage(msg);
    }
  }

  // ëŒ€ê¸°ì •ë³´: í•™ë°˜/ê°•ì¢Œ, ë‹´ì„/ê°•ì‚¬, ëŒ€ê¸°ë²ˆí˜¸ ì•ˆë‚´
  function handleWaitingInfo() {
    const waitingList = [
      // ì˜ˆì‹œ:
      // { lecture: "ê³ 3 êµ­ì–´ ì‹¬í™”ë°˜", teacher: "ê¹€íƒœí›ˆT", waitNo: 3 },
      // { lecture: "Nìˆ˜ ìˆ˜í•™ ë‹¨ê³¼", teacher: "ë°•ìŠ¹í˜„T", waitNo: 1 }
    ];

    if (waitingList.length === 0) {
      addBotMessage("í˜„ì¬ ëŒ€ê¸°ì¤‘ì¸ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    let msg = "ğŸ“‹ ëŒ€ê¸°ì •ë³´ ëª©ë¡\n\n";
    waitingList.forEach((item, i) => {
      msg += `${i + 1}) í•™ë°˜/ê°•ì¢Œ: ${item.lecture}\n`;
      msg += `   ë‹´ì„/ê°•ì‚¬: ${item.teacher}\n`;
      msg += `   ëŒ€ê¸°ë²ˆí˜¸: ${item.waitNo}ë²ˆ\n\n`;
    });

    addBotMessage(msg);
  }

  // ê²°ì œë‚´ì—­: í•™ì›/ê²°ì œì¼ì/êµ¬ë§¤ë‚´ì—­/ê¸ˆì•¡/ìˆ˜ë‹¨/ìƒíƒœ ì•ˆë‚´
  function handlePaymentInfo() {
    const paymentList = [
      // ì˜ˆì‹œ:
      // {
      //   campus: "ëŸ¬ì…€ ëŒ€ì¹˜",
      //   date: "2025-01-03",
      //   item: "ê³ 3 ìˆ˜í•™ ë‹¨ê³¼",
      //   amount: "350,000ì›",
      //   method: "ì¹´ë“œê²°ì œ(ì‚¼ì„±)",
      //   status: "ê²°ì œì™„ë£Œ"
      // }
    ];

    if (paymentList.length === 0) {
      addBotMessage("ğŸ’³ ê²°ì œë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    let msg = "ğŸ’³ ê²°ì œë‚´ì—­\n\n";
    paymentList.forEach((p, i) => {
      msg += `${i + 1}) í•™ì›: ${p.campus}\n`;
      msg += `   ê²°ì œì¼ì: ${p.date}\n`;
      msg += `   êµ¬ë§¤ë‚´ì—­: ${p.item}\n`;
      msg += `   ê²°ì œê¸ˆì•¡: ${p.amount}\n`;
      msg += `   ê²°ì œìˆ˜ë‹¨: ${p.method}\n`;
      msg += `   ìƒíƒœ: ${p.status}\n\n`;
    });

    addBotMessage(msg);
  }

  /* ===============================
     [ìš°ì„ ì¶”ê°€] í™˜ë¶ˆì‹ ì²­ í•˜ìœ„ ë©”ë‰´ (ë‹¨ê³¼/êµì¬/ë°”ìê´€)
     =============================== */

  function renderRefundSubMenu() {
    addBotMessage("ì›í•˜ì‹œëŠ” í™˜ë¶ˆ ìœ í˜•ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");

    btnTitle.textContent = "í™˜ë¶ˆì‹ ì²­ ì„¸ë¶€ ë©”ë‰´";
    btnList.innerHTML = "";

    const subMenus = [
      { label: "ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­" },
      { label: "êµì¬í™˜ë¶ˆ ì‹ ì²­" },
      { label: "ë°”ìê´€í™˜ë¶ˆ ì‹ ì²­" }
    ];

    subMenus.forEach(sub => {
      const b = document.createElement("button");
      b.className = "chip-btn";
      b.textContent = sub.label;

      if (sub.label === "ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­") {
        b.onclick = () => handleRefundSingle();
      } else {
        b.onclick = () => addBotMessage(`${sub.label} ê¸°ëŠ¥ì€ ì¶”í›„ ì˜¤í”ˆ ì˜ˆì •ì…ë‹ˆë‹¤.`);
      }

      btnList.appendChild(b);
    });

    const homeBtn = document.createElement("button");
    homeBtn.className = "chip-btn";
    homeBtn.textContent = "â—€ ë‚˜ì˜ ìˆ˜ê°•ì •ë³´ë¡œ";
    homeBtn.onclick = () => openMenu("ë‚˜ì˜ ìˆ˜ê°•ì •ë³´");
    btnList.appendChild(homeBtn);
  }

  /* ===============================
     í•™ìƒ ì •ë³´ ê´€ë¦¬(localStorage) + êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ + ë‹¨ê³¼ í™˜ë¶ˆ ì²˜ë¦¬
     =============================== */

  // í•™ìƒ ì •ë³´(ì´ë¦„/í•™ë²ˆ)ë¥¼ ìµœì´ˆ 1íšŒ ì…ë ¥ë°›ê³  localStorageì— ì €ì¥
  function getStudentInfo() {
    let name = localStorage.getItem("studentName");
    let studentId = localStorage.getItem("studentId");

    if (!name || !studentId) {
      name = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”:");
      studentId = prompt("ì¬ì›ìƒ í•™ë²ˆ(6~7ìë¦¬)ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”:");

      if (!name || !studentId) {
        alert("ì´ë¦„ê³¼ í•™ë²ˆ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return null;
      }

      localStorage.setItem("studentName", name);
      localStorage.setItem("studentId", studentId);
    }

    return { name, studentId };
  }

  // êµ¬ê¸€ ì‹œíŠ¸(Google Apps Script Webhook)ë¡œ í™˜ë¶ˆ ì •ë³´ë¥¼ ì „ì†¡
  function sendRefundToSheet(type, name, studentId, courses) {
    fetch(SHEET_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: type,           // "single" | "book" | "bazaar"
        name: name,           // í•™ìƒ ì´ë¦„
        studentId: studentId, // ì¬ì›ìƒ í•™ë²ˆ
        courses: courses      // í™˜ë¶ˆ ì‹ ì²­ ê°•ì¢Œ ë°°ì—´
      })
    })
      .then(res => res.text())
      .then(text => {
        console.log("Google Sheet Response:", text);
      })
      .catch(err => {
        console.error("Error:", err);
      });
  }

  // ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­: í˜„ì¬ ìˆ˜ê°•ì¤‘ ê°•ì¢Œì—ì„œ ì¤‘ë³µ ì„ íƒ í›„ ì‹œíŠ¸ì— ìë™ ì…ë ¥
  function handleRefundSingle() {
    const student = getStudentInfo();
    if (!student) return;

    const courseList = currentCoursesData || [];

    if (courseList.length === 0) {
      addBotMessage("ğŸ“Œ í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    addBotMessage("í™˜ë¶ˆ ì‹ ì²­í•  ê°•ì¢Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.\n(ì—¬ëŸ¬ ê³¼ëª© ì„ íƒ ê°€ëŠ¥)");

    btnTitle.textContent = "ë‹¨ê³¼í™˜ë¶ˆ ì‹ ì²­ - ê°•ì¢Œ ì„ íƒ";
    btnList.innerHTML = "";

    courseList.forEach(course => {
      const label = document.createElement("label");
      label.style.display = "flex";
      label.style.alignItems = "center";
      label.style.gap = "6px";
      label.style.fontSize = "12px";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = course;

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(course));
      btnList.appendChild(label);
    });

    const okBtn = document.createElement("button");
    okBtn.className = "chip-btn";
    okBtn.textContent = "ì„ íƒ ì™„ë£Œ";
    okBtn.style.marginTop = "10px";

    okBtn.onclick = () => {
      const selected = [...btnList.querySelectorAll("input[type=checkbox]:checked")].map(x => x.value);

      if (selected.length === 0) {
        addBotMessage("ì„ íƒëœ ê°•ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      addBotMessage(`ì´ ${selected.length}ê°œ ê°•ì¢Œ í™˜ë¶ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);

      // ì„ íƒí•œ ê°•ì¢Œ ì •ë³´ë¥¼ êµ¬ê¸€ ì‹œíŠ¸ì— ê¸°ë¡
      sendRefundToSheet("single", student.name, student.studentId, selected);
    };

    btnList.appendChild(okBtn);
  }

  /* ===============================
     ì´ˆê¸°í™” & russel.json ë¡œë”©
     =============================== */

  function initChatbot() {
    const firstMsg =
      "ì•ˆë…•í•˜ì„¸ìš”. ë©”ê°€ìŠ¤í„°ë”” ëŸ¬ì…€ ëŒ€ì¹˜í•™ì› ì±—ë´‡ì…ë‹ˆë‹¤.\n\n" +
      "í•™ì› ì´ìš©, ëª¨ì§‘ìš”ê°•, ë‹¨ê³¼ ì‹œê°„í‘œ, ììŠµì „ìš©ê´€, ëª¨ì˜ê³ ì‚¬, ì¶œê°• ì„ ìƒë‹˜, ë‚˜ì˜ ìˆ˜ê°•ì •ë³´ê¹Œì§€\n" +
      "ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
    addBotMessage(firstMsg);
    renderMainButtons();
  }

  // russel.json ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadMenuData() {
    try {
      addBotMessage("ë©”ë‰´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...");
      const res = await fetch("russel.json");
      if (!res.ok) {
        throw new Error("russel.jsonì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
      const data = await res.json();
      MENU_DATA = data;
      MAIN_MENUS = Object.keys(MENU_DATA);
      // ë¡œë”© ë©”ì‹œì§€ ì´í›„ ì´ˆê¸°í™”
      initChatbot();
    } catch (err) {
      console.error(err);
      addBotMessage("ë©”ë‰´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. russel.json íŒŒì¼ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    }
  }

  // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í›„ ë°”ë¡œ JSON ë¡œë”© ì‹œì‘
  loadMenuData();
</script>
</body>
</html>
